language: generic

os:
  - linux
  - osx

cache:
  directories:
    - "$HOME/miniconda"
    - "$HOME/miniconda.sh"

before_install:
  - if [[ $(uname -s) == "Darwin" ]]; then wget https://repo.continuum.io/miniconda/Miniconda3-latest-MacOSX-x86_64.sh
    -O miniconda.sh; else wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh
    -O miniconda.sh; fi
  - bash miniconda.sh -b -u -p $HOME/miniconda
  - export PATH="$HOME/miniconda/bin:$PATH"
  - hash -r
  - conda config --set always_yes yes --set changeps1 no
  - conda update -q conda
  - conda install conda-env
  - conda info -a
  - conda env update
  - pip install codecov

install:
  - source activate sdanalysis-dev
  - python setup.py install --single-version-externally-managed --record record.txt

before_cache:
  - tr '\n' '\0' < record.txt | xargs -0 sudo rm -f --
  - conda clean --all
  - rm ~/miniconda/conda-meta/history
  - rm ~/miniconda/envs/sdanalysis-dev/conda-meta/history
  - rm -r ~/miniconda/lib/python3.6/__pycache__

script:
  - pytest

after_success:
  - codecov

before_deploy:
  - conda install -n root anaconda-client conda-build
  - conda config --append channels conda-forge
  - conda config --append channels moble
  - chmod +x scripts/deploy_anaconda.sh

deploy:
  - provider: pypi
    user: malramsay64
    password:
      secure: "j5NFtYX51pPYpF0QcxulDpWpviKKjualefN5ZPjfoLQXfM+t238ruxYwAqz57a00AELZqOAUItJQWl31JvA01KKX5H4iPZPGtyEx9RNW75kgs8/VVlJkS/HMGZoyf8Jkup2RVjbDPs30Ryf/3BVOdUX60Qg2BJ1ZlV5ZSd+4pAXEktl/G/5j2Ca7Nuxo67OW4BHCq4rp0JzlwwIWJjNnA/9prTeqUKn0Pim4XDSmYEwOfdMYRvRa6biDQbCdpqEoQ+57SMVEnQ1lfcQDqHtVpHoTc6/CiwyPytbkp8bGzFEpeEKbBsdz6RV3dE/hsp6nNey5IInGF7sGzi+3YKX9DhgVLhYR8D+WOCEard8g5lE7LXMhfTbdlnrAmURHu7G/+v6K0TgvMjmyCdEFByOOAr3a2bjAS1TwihSv23zXfW2+bWrJ4Bs8e1sedo7GYtaoaeDB2vJJ3fAX46B60vDJtw1yqTaLCya4LrKRa4JPnEFUeMNm9wV2fOj7Wc3gIniY9RQnYNhiingUBgmJCgYUQWXaeNNMjNo/WvoXj9a38d0a6S/zqXFmYH7ZLKJiKZQIwkaZMLLDSbdjhzrIQrcmYnVttG6x5QZ8k6jpVONyoeYLErHCEU3d11syWnCNjInA9loM9tab/gO8j9GrPiizBpty6G7etnAr+U9HGUuGhTw="
    on:
      tags: true
  - provider: script
    script: "./scripts/deploy_anaconda.sh"
    on:
      tags: true
